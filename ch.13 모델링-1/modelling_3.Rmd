---
title: "사전예측분포"
author: "cslee"
date: "2025-03-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(rstan)
library(bayesplot)
library(mltools)
library(gridExtra)
library(rstanarm)
```


### 사전 예측 검증

사전 예측 검증(Prior predictive checking)은 사전분포를 사용하여 모형이 관측된 데이터를 얼마나 잘 재현하는 지 평가한다. 구체적으로, 사전분포 하에서 생성된 데이터셋 중 실제 데이터셋과 일치하는 데이터 세트가 얼마나 되는 지 확인한다. 이러한 검증은 실제 데이터와 비슷한 경향을 보여주지는 않지만, 극단값이 너무 강하거나, 너무 약하거나, 형태가 부적절하거나, 위치가 부적절한 사전(prior)을 진단하는 데 도움이 된다.

다음과 같은 사전 예측 분포에서 새로운 데이터를 생성한다.
$$ 
\begin{equation}
p(y^{rep}) = \int p(y^{rep} | \lambda) p(\lambda) d\lambda
\end{equation}
$$
  
예시의 포아송 모형에 대해 stan으로 사전 예측 분포를 확인해보자.

```{r}
# 1) Stan 코드 정의
poisson_prior_model <- "
data {
  int<lower=0> N;
}
parameters {
  real<lower=0> lambda;
}
model {
  lambda ~ exponential(0.2);
}
generated quantities {
  array[N] int<lower=0> y_rep = poisson_rng(rep_array(lambda, N));
}
"

# 2) Stan 모델 컴파일 및 샘플링
# 예시로 'n'이 미리 정의되었다고 가정 (실제로는 n <- 30 등)
n <- 30
# 관측값 y 라고 가정한 예시 (실제로는 사용 중인 데이터에 맞춰 수정)
# 여기선 단순히 어떤 벡터를 만든다고 가정
y <- rpois(n, 5)

pois_prior_stan_model <- stan_model(model_code = poisson_prior_model)
fit_poisson_prior <- sampling(
  pois_prior_stan_model,
  data = list(N = n),
  chains = 4, iter = 1000, warmup = 500, seed = 123
)
```


```{r}
# 3) Posterior Predictive(여기서는 사실 'Prior Predictive') 추출
prior_predictive <- extract(fit_poisson_prior, pars = "y_rep")[[1]]

```

```{r}
# 4) ggplot을 이용하여 시각화
library(ggplot2)
g_pois_prior <- data.frame(pois_sample = y) %>%
  ggplot(aes(x = pois_sample)) +
  geom_histogram(
    aes(y = after_stat(density)),
    binwidth = 1, fill = "skyblue", color = "black"
  ) +
  labs(
    title = "Prior Predictive Distribution",
    x = "Number of events", 
    y = "density"
  ) +
  xlim(0, 30)

# 여러 번의 사전 샘플(100개)만 골라 곡선 겹쳐 그리기
for (i in 1:100) {
  g_pois_prior <- g_pois_prior +
    geom_density(
      data = data.frame(pois_sample = prior_predictive[i, ]),
      colour = "blue", linewidth = 0.2
    )
}

# 5) 최종 플롯 출력
g_pois_prior
```












